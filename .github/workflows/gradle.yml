name: Backend build

on:
  push:
    branches: [ main ]
    paths:
      - be/**
      - .github/workflows/gradle.yml
      - .github/actions/setup-java-gradle/action.yml
  pull_request:
    branches: [ main ]
    paths:
      - be/**
      - .github/workflows/gradle.yml
      - .github/actions/setup-java-gradle/action.yml

permissions:
  contents: read

defaults:
  run:
    working-directory: ./be

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/setup-java-gradle
      - uses: actions/cache@v5
        with:
          path: ~/.gradle/wrapper/dists
          key: gradle-wrapper-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties') }}
      - uses: actions/cache@v5
        with:
          path: be/**/build
          key: gradle-build-${{ github.sha }}
          restore-keys: |
            gradle-build-
      - run: ./gradlew assemble

  test:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/setup-java-gradle
      - uses: actions/cache@v5
        with:
          path: ~/.gradle/wrapper/dists
          key: gradle-wrapper-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties') }}
      - uses: actions/cache@v5
        with:
          path: be/**/build
          key: gradle-build-${{ github.sha }}
      - run: ./gradlew test testCodeCoverageReport
      - uses: actions/cache@v5
        with:
          path: |
            be/**/build/test-results
            be/**/build/reports
            be/build/reports/jacoco/testCodeCoverageReport/testCodeCoverageReport.xml
          key: gradle-test-${{ github.sha }}

  lint:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/setup-java-gradle
      - uses: actions/cache@v5
        with:
          path: ~/.gradle/wrapper/dists
          key: gradle-wrapper-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties') }}
      - uses: actions/cache@v5
        with:
          path: be/**/build
          key: gradle-build-${{ github.sha }}
      - run: ./gradlew checkstyleMain checkstyleTest pmdMain pmdTest

  sonar:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - uses: ./.github/actions/setup-java-gradle
      - uses: actions/cache@v5
        with:
          path: ~/.gradle/wrapper/dists
          key: gradle-wrapper-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties') }}
      - uses: actions/cache@v5
        with:
          path: be/**/build
          key: gradle-build-${{ github.sha }}
      - uses: actions/cache@v5
        with:
          path: |
            be/**/build/test-results
            be/**/build/reports
            be/build/reports/jacoco/testCodeCoverageReport/testCodeCoverageReport.xml
          key: gradle-test-${{ github.sha }}
      - run: ./gradlew sonar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      - name: SonarQube Quality Gate check
        uses: sonarsource/sonarqube-quality-gate-action@master
        with:
          scanMetadataReportFile: ./be/build/sonar/report-task.txt
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  dependency-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Dependency check
        uses: dependency-check/Dependency-Check_Action@main
        env:
          JAVA_HOME: /opt/jdk
        id: Dependency_check
        with:
          project: 'inventory-backend'
          path: '.'
          format: 'HTML'
          out: 'reports'
          args: >
            --failOnCVSS 10
            --enableRetired
            --exclude **/package.json
            --exclude **/package-lock.json
            --exclude **/yarn.lock
      - name: Upload Test results
        uses: actions/upload-artifact@v7
        with:
          name: Dependency check report
          path: ${{github.workspace}}/reports
